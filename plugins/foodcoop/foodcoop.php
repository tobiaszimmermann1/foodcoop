<?php/*Plugin Name: Foodcoop PluginPlugin URI: https://neues-food-depot.chDescription: Plugin for FoodcoopsAuthor: Tobias ZimmermannAuthor URI: https://neues-food-depot.chLicense: GPLv2 or laterText Domain: foodcoop*/// Check if WooCommerce & ACF is runningif ( in_array( 'woocommerce/woocommerce.php', apply_filters( 'active_plugins', get_option( 'active_plugins' ) ) ) ) {if (class_exists('ACF')) {// INCLUDE STYLESHEETS AND SCRIPTSfunction foodcoop_plugin_stylesheet() {  wp_register_style('foodcoop_styles', '/wp-content/plugins/foodcoop/styles/foodcoop.css');  wp_enqueue_style('foodcoop_styles');}add_action('init', 'foodcoop_plugin_stylesheet');wp_register_script( 'ordering_script', plugins_url('/scripts/ordering.js', __FILE__), array('jquery'));wp_enqueue_script( 'ordering_script' );// CREATE CUSTOM POST TYPE BESTELLRUNDENfunction custom_post_type_bestellrunden() {	$labels = array(		'name'                  => __( 'Bestellrunden'),		'singular_name'         => __( 'Bestellrunde'),		'menu_name'             => __( 'Bestellrunden'),		'name_admin_bar'        => __( 'Bestellrunden'),		'archives'              => __( 'Bestellrundenarchiv'),		'all_items'             => __( 'Alle Bestellrunden'),		'add_new_item'          => __( 'Neue Bestellrunde hinzufügen'),		'add_new'               => __( 'Hinzufügen'),		'new_item'              => __( 'Bestellrunde hinzufügen'),		'edit_item'             => __( 'Bestellrunde bearbeiten'),		'update_item'           => __( 'Bestellrunde speichern'),		'view_item'             => __( 'Bestellrunde ansehen'),		'view_items'            => __( 'Bestellrunden ansehen'),	);	$args = array(		'label'                 => __( 'Bestellrunden'),		'labels'                => $labels,		'supports'              => false,		'taxonomies'            => array(),		'hierarchical'          => false,		'public'                => true,		'show_ui'               => true,		'show_in_menu'          => true,		'show_in_admin_bar'     => true,		'show_in_nav_menus'     => true,		'can_export'            => true,		'has_archive'           => true,		'exclude_from_search'   => false,		'publicly_queryable'    => true,		'capability_type'       => 'post',	);	register_post_type( 'bestellrunden', $args );}add_action( 'init', 'custom_post_type_bestellrunden', 0 );// ADD CUSTOM FIELDS TO PRODUCTS// Display Fieldsadd_action('woocommerce_product_options_general_product_data', 'woocommerce_product_custom_fields');// Save Fieldsadd_action('woocommerce_process_product_meta', 'woocommerce_product_custom_fields_save');function woocommerce_product_custom_fields(){    global $woocommerce, $post;    echo '<div class="product_custom_field">';    //Custom Product Number Field    woocommerce_wp_text_input(        array(            'id' => '_gebinde',            'placeholder' => 'Gebindegrösse',            'label' => __('Gebindegrösse', 'woocommerce'),            'type' => 'number',            'custom_attributes' => array(                'step' => '1',                'min' => '1'            )        )    );    // Custom Product Text Field    woocommerce_wp_text_input(        array(            'id' => '_einheit',            'placeholder' => 'Einheit',            'label' => __('Einheit', 'woocommerce'),            'desc_tip' => 'true'        )    );    // Custom Product Text Field    woocommerce_wp_text_input(        array(            'id' => '_lieferant',            'placeholder' => 'Lieferant',            'label' => __('Lieferant', 'woocommerce'),            'desc_tip' => 'true'        )    );    // Custom Product Text Field    woocommerce_wp_text_input(        array(            'id' => '_herkunft',            'placeholder' => 'Herkunft',            'label' => __('Herkunft', 'woocommerce'),            'desc_tip' => 'true'        )    );    echo '</div>';}function woocommerce_product_custom_fields_save($post_id){// Custom Product Text Field    $woocommerce_einheit = $_POST['_einheit'];    if (!empty($woocommerce_einheit))        update_post_meta($post_id, '_einheit', esc_attr($woocommerce_einheit));// Custom Product Text Field    $woocommerce_lieferant = $_POST['_lieferant'];    if (!empty($woocommerce_lieferant))        update_post_meta($post_id, '_lieferant', esc_attr($woocommerce_lieferant));// Custom Product Text Field    $woocommerce_herkunft = $_POST['_herkunft'];    if (!empty($woocommerce_herkunft))        update_post_meta($post_id, '_herkunft', esc_attr($woocommerce_herkunft));// Custom Product Number Field    $woocommerce_gebinde = $_POST['_gebinde'];    if (!empty($woocommerce_gebinde))        update_post_meta($post_id, '_gebinde', esc_attr($woocommerce_gebinde));}// PRODUCT LIST BY CATEGORY FUNCTIONfunction foodcoop_products_list_function() {// CHECK FIRST IF BESTELLRUNDE IS CURRENTLY ACTIVE$args = array(    'post_type' => 'bestellrunden',    'post_status' => 'publish',    'orderby' => 'id',    'order' => 'DESC',);$loop = new WP_Query( $args );while ( $loop->have_posts() ) : $loop->the_post(); $bestellrunde_start = new DateTime(get_field( "bestellrunde_start" )); $bestellrunde_ende = new DateTime(get_field( "bestellrunde_ende" )); $current_date = new DateTime(date("j.m.Y")); if ($bestellrunde_start < $current_date AND $bestellrunde_ende > $current_date) {   $active = true;   $current_bestellrunde_start = get_field( "bestellrunde_start" );   $current_bestellrunde_ende = get_field( "bestellrunde_ende" );   $current_verteiltag = get_field( "verteiltag" ); }endwhile;wp_reset_postdata();if ($active) {  $args = array(   'taxonomy'   => "product_cat",   'number'     => $number,   'orderby'    => 'title',   'order'      => 'DESC',   'hide_empty' => $hide_empty,   'exclude'    => 15  );  $product_categories = get_terms($args);  echo "<form action='../wp-content/plugins/foodcoop/order.php' method='post'>";  ?>    <table id='bestellrunde'>    <tr>      <td>Bestellen bis:</td>      <td><?php echo $current_verteiltag; ?></td>    </tr>    <tr>      <td>Verteiltag:</td>      <td><?php echo $current_bestellrunde_ende; ?></td>    </tr>    </table>  <?php  echo "<table id='foodcoop-order-table'>";  foreach( $product_categories as $cat ) {    $args = array(        'category' => array( $cat->slug ),        'limit' => -1,        'status' => 'publish'    );    $products = wc_get_products( $args );    echo "    <tr>      <th class='table-category' colspan='8'>".$cat->name."</th>    </tr>    <tr>      <td class='table-title'>Menge</td>      <td class='table-title'>Toleranz</td>      <td class='table-title'>Produkt</td>      <td class='table-title'>Lieferant</td>      <td class='table-title'>Preis</td>      <td class='table-title'>Einheit</td>      <td class='table-title'>Gebindegrösse</td>      <td class='table-title'>Notiz</td>    </tr>";        foreach( $products as $product ) {          $product_id = $product->get_id();          echo "<tr>            <td class='table-row product-number'><input class='foodcoop-list-number' type='number' value='0' name='products[".$product_id."]' id='".$product_id."'></td>            <td class='table-row product-toleranz'><input class='foodcoop-list-toleranz' type='number' name='toleranz[".$product_id."]' value='0' id='".$product_id."'></td>            <td class='table-row product-name'>".$product->name."</td>            <td class='table-row product-lieferant'>";              echo get_post_meta( $product->get_id(), '_lieferant', true );            echo "</td>";            $price = number_format($product->price, 2);            echo "<td class='table-row product-price' id='price-".$product_id."'>".$price."</td>            <td class='table-row product-einheit'>";              echo get_post_meta( $product->get_id(), '_einheit', true );            echo "</td>            <td class='table-row product-gebinde'>";              echo get_post_meta( $product->get_id(), '_gebinde', true );            echo "</td>            <td class='table-row product-description'>";            echo $product->get_short_description();            echo "</td>          </tr>";        }  }  echo "</table>"; ?>  <div id="foodcoop-order-bar">    <div class="order-bar-item" id="foodcoop-order-total">Total Bestellung: CHF 0.00 </div>    <input type='submit' id='foodcoop-order-submit' value='Bestellen'>  </div>  <?php echo "</form>";}else {  echo "<p>Das nächste Bestellfenster öffnet am: </p>";}}// REGISTER SHORTCODE FOR PRODUCTS LISTadd_shortcode('foodcoop_products', 'foodcoop_products_list_function');} }